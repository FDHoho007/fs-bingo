var audio;

/**
 * Renders the game field and from the array that is being generated by the getContent function.
 */
async function renderGameField() {

    // array containing sqr(n) strings of possible options to chose from
    let options = [];

    try {
        options = await getContent();
    } catch (e) {
        if (e instanceof InvalidSubdomainError) {
            alert("Diese Seite ist nicht bekannt.")
            return;
        }

        if (e instanceof InvalidConfigurationError) {
            alert("Geladene daten haben kein valides Format.")
            return;
        }
    }

    // both width and height of game field since options has length sqr(n)
    const width = Math.sqrt(options.length);
    // table representing the game board
    const gameBoard = document.getElementById("board");
    // clear the game board
    document.querySelectorAll("#board div").forEach(e => e.remove());

    for (let i = 0; i < width; i++) {
        const row = document.createElement("div");
        for (let j = 0; j < width; j++) {
            const cell = document.createElement("div");
            const text = document.createElement("p");
            text.innerText = options.pop().toString();
            cell.classList = "cell";
            cell.onclick = (e) => clickField(cell);
            cell.appendChild(text);
            row.appendChild(cell);
        }
        gameBoard.appendChild(row);
    }
    gameBoard.style.maxWidth = width*166 + "px";
    resizeText({
        elements: document.querySelectorAll('.cell p'),
        step: 0.5
    })
}



function renderTitle() {
    const name = getSubdomain().toLowerCase();
    document.getElementById("title").innerText = "Fachschaftsbingo! Heute mit " + name[0].toUpperCase()
        + name.slice(1);
}

function spawnConfetti() {
    var duration = 15 * 1000;
    var animationEnd = Date.now() + duration;
    var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

    function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
    }

    var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
        return clearInterval(interval);
    }

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
    }, 250);
}

function playSound() {
    const audioLinkList = [
        "https://soundboard-web.pages.dev/sounds/federball.mp3",
        "https://soundboard-web.pages.dev/sounds/Wyld.mp3",
        "https://soundboard-web.pages.dev/sounds/Sheesh.mp3",
        "https://soundboard-web.pages.dev/sounds/Papatastisch.mp3",
        "https://soundboard-web.pages.dev/sounds/spacetaxitothesky.mp3",
        "https://soundboard-web.pages.dev/sounds/perversgeil.mp3"
    ];

    var rndIndex = Math.floor(Math.random() * audioLinkList.length);
    var audioLink = audioLinkList[rndIndex];
    console.log("Playing audio at url: " + audioLink + "which is " + rndIndex);
    audio = new Audio(audioLink);
    audio.volume = 1;
    audio.play();
}

function win() {
    //alert("Yeah du hast alles! BINGO!")
    spawnConfetti();
    playSound();
}

if (location.hostname === "fs.bingo") {
    location.href = "https://github.com/FDHoho007/fs-bingo";
}
else {
    // start to render the ui now
    renderGameField();
    renderTitle();
}